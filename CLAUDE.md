# CLAUDE.md — Guardian Development Guide

This file is the authoritative reference for AI-assisted development and maintenance of this project.
Read this before touching any code.

---

## Project in one sentence

Guardian is a macOS 14+ **menu-bar agent** that manages arbitrary shell commands as **launchd LaunchAgents**.
It monitors process status; it does NOT directly keep processes alive — launchd does.

---

## Build commands

```bash
# First time setup
brew install xcodegen
xcodegen generate       # creates Guardian.xcodeproj from project.yml
open Guardian.xcodeproj # then ⌘R in Xcode

# After adding/removing source files
xcodegen generate       # regenerates .xcodeproj; do NOT edit .xcodeproj manually

# CI build (same as GitHub Actions)
xcodebuild build \
  -project Guardian.xcodeproj -scheme Guardian -configuration Release \
  -destination 'platform=macOS,arch=arm64' \
  CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO \
  CONFIGURATION_BUILD_DIR="$PWD/build/output"
```

**Requirements:** Xcode 16+, macOS 14+, Homebrew (for xcodegen)

---

## Project structure

```
Guardian/
├── project.yml                    ← xcodegen spec — SINGLE SOURCE OF TRUTH for project config
├── Makefile                       ← make setup / make open / make build
├── .github/
│   ├── workflows/ci.yml           ← builds on push to main / PRs
│   └── workflows/release.yml      ← builds + publishes GitHub Release on v* tags
└── Guardian/
    ├── Info.plist                 ← generated by xcodegen; do NOT edit directly
    │                                 edit via project.yml info.properties instead
    ├── Resources/
    │   └── Guardian.entitlements  ← sandbox=false, service-management=true
    ├── App/
    │   ├── GuardianApp.swift      ← @main; Window + MenuBarExtra scenes
    │   └── AppDelegate.swift      ← applicationShouldTerminateAfterLastWindowClosed=false
    ├── Models/
    │   ├── ProcessConfig.swift    ← Codable struct; plistURL computed from label
    │   ├── ProcessStatus.swift    ← enum running/stopped/crashed/notLoaded/unknown
    │   └── ProcessStore.swift     ← @MainActor ObservableObject; all business logic here
    ├── Services/
    │   ├── LaunchdService.swift   ← actor; all launchctl calls (no shell strings)
    │   ├── PlistGenerator.swift   ← writes LaunchAgent plist XML
    │   ├── LogWatcher.swift       ← DispatchSource file watcher; @MainActor
    │   ├── LoginItemService.swift ← SMAppService.mainApp wrapper
    │   └── PersistenceManager.swift ← JSON r/w at ~/Library/Application Support/com.guardian.app/
    └── Views/
        ├── GuardianApp.swift
        ├── MenuBarView.swift
        ├── MainWindowView.swift
        ├── ProcessListView.swift
        ├── ProcessRowView.swift
        ├── ProcessDetailView.swift   ← hosts LogWatcher as @StateObject
        ├── AddEditProcessView.swift
        ├── LogView.swift
        ├── SettingsView.swift
        └── StatusColor.swift         ← ProcessStatus.color extension
```

---

## Architecture decisions (with rationale)

### LSUIElement = true (no Dock icon)
- Set in `project.yml` → `info.properties.LSUIElement: true`
- **Do NOT use dynamic `NSApp.setActivationPolicy` switching** — it causes Dock icon flicker and race conditions
- `NSApp.activate(ignoringOtherApps: true)` is still needed to bring a window to front from menu bar
- System Events (`osascript`) will **timeout** for LSUIElement apps — this is expected, not a bug

### Info.plist is generated by xcodegen — never edit it directly
- Every `xcodegen generate` run overwrites `Guardian/Info.plist` from `project.yml`'s `info.properties`
- **Pitfall found in v0.1.0:** `LSUIElement` was missing from the built app because we had a static `Info.plist`
  that xcodegen kept overwriting with a minimal template. Fixed by moving all custom keys to `project.yml`
- To add a new Info.plist key, edit `project.yml` → `targets.Guardian.info.properties`

### launchd API: bootstrap/bootout only (not load/unload)
```
Load:    launchctl bootstrap gui/<uid> <plist-path>
Unload:  launchctl bootout   gui/<uid>/<label>
Start:   launchctl kickstart -kp gui/<uid>/<label>
Signal:  launchctl kill SIGTERM gui/<uid>/<label>   ← NOT system kill; launchd-managed processes
Status:  launchctl list <label>                      ← returns old-style plist, parse with PropertyListSerialization
```
- `load`/`unload` are deprecated since macOS 10.10
- `launchctl list <label>` output format: `{ "PID" = 12345; "LastExitStatus" = 0; ... }`
  - PID present → running
  - No PID + LastExitStatus == 0 → stopped cleanly
  - No PID + LastExitStatus != 0 → crashed (signal kills encode as exitCode = signal << 8 ... but typically shows raw signal number)
- **Do NOT use `kill -9 $PID`** on launchd-managed processes — will get "operation not permitted"
  Use `launchctl kill SIGKILL gui/<uid>/<label>` instead

### KeepAlive behavior (important for UI)
- If `KeepAlive=true` in plist, launchd **will restart** the process after SIGTERM
- The "Stop" button intentionally sends SIGTERM; the process will restart — this is correct behavior
- To truly stop a KeepAlive process: use "Disable" (`bootout`) without deleting the plist
- launchd throttle: after a crash, launchd waits ~10 seconds before restarting (exponential backoff)
  During this window, status shows `crashed` — expected

### Status polling (no push API from launchd)
- `ProcessStore` polls every 5 seconds via `Task { while !Task.isCancelled { sleep 5; refresh } }`
- Concurrently queries all processes with `withTaskGroup`
- launchd provides no KVO or notification API for agent state changes

### LogWatcher: DispatchSource + FileHandle
```swift
// Open at EOF (tail mode)
fh.seekToEndOfFile()
// Watch for writes
DispatchSource.makeFileSystemObjectSource(fd, eventMask: [.write, .extend])
// On fire: read new bytes
fh.readDataToEndOfFile()
```
- Does NOT handle log rotation (file replacement). To add: also watch `.delete` / `.rename` and reopen
- Max 2000 lines kept in memory (ring buffer in `LogWatcher`)
- `loadHistory(path:lineCount:)` reads last N lines for on-demand history

### App Sandbox: DISABLED
- **Required.** Without it, we cannot write `~/Library/LaunchAgents/` or exec `launchctl`
- This means: **no Mac App Store distribution**. Distribute via GitHub Releases or Homebrew Cask
- Entitlements: `com.apple.security.app-sandbox = false`, `com.apple.developer.service-management.control = true`

### xcodegen and project.yml
- The `.xcodeproj` is NOT committed to git (it's in `.gitignore`)
- `xcodegen generate` regenerates it from `project.yml`
- **After adding any new Swift file**, run `xcodegen generate` — otherwise Xcode won't compile it
- Key project.yml sections:
  - `targets.Guardian.sources` — source roots (currently just `path: Guardian` with `excludes: [Info.plist]`)
  - `targets.Guardian.info.properties` — Info.plist contents (LSUIElement lives here)
  - `targets.Guardian.settings.base` — build settings

---

## CI / CD

### ci.yml (push to main / PRs)
1. Select Xcode 16.2
2. `brew install xcodegen`
3. `xcodegen generate`
4. `xcodebuild build ... | xcpretty` with `set -o pipefail`
5. Verify `build/output/Guardian.app` exists

**Pitfall fixed:** xcpretty exits 0 even when xcodebuild fails → CI reported success on build errors.
Fixed with `set -o pipefail` so the pipe propagates xcodebuild's exit code.

### release.yml (push v* tag)
Same build steps, then:
- `ditto -c -k --keepParent Guardian.app "Guardian-v*.zip"`
- `softprops/action-gh-release@v2` to publish

**Pitfall fixed:** `GITHUB_TOKEN` needs `permissions: contents: write` to create releases.

### Cut a release
```bash
git tag v1.2.3 && git push origin v1.2.3
```

---

## Compile errors encountered and fixed

| Error | Root cause | Fix |
|-------|-----------|-----|
| `type 'ShapeStyle' has no member 'accentColor'` | `.accentColor` is `Color`, not `ShapeStyle` | Change to `Color.accentColor` in `SettingsView.swift` |
| `result of 'try?' is unused` | `bootout()` declared `throws` but used `try?` internally | Remove `throws` from `bootout()`, add `_ =` prefix |
| Missing imports | `@Published`/`ObservableObject` need `import Combine`; `NSWorkspace` needs `import AppKit` | Added to `ProcessStore.swift`, `LogWatcher.swift`, `LoginItemService.swift`, `AddEditProcessView.swift` |
| `ContentUnavailableView` unavailable | Requires macOS 14+, target was 13.0 | Bumped `project.yml` deployment target to `14.0` |
| `onChange(of:)` 2-arg form unavailable | Also macOS 14+ | Same fix |

---

## Runtime pitfalls

### launchd plist label must match filename
The plist file MUST be named `<Label>.plist`. `ProcessConfig.plistURL` enforces this:
```swift
var plistURL: URL {
    homeDir.appendingPathComponent("Library/LaunchAgents/\(label).plist")
}
```

### Log directory must exist before launchd starts the process
`PlistGenerator.writePlist()` creates `~/Library/Logs/Guardian/` before writing the plist.
If this directory is missing, `StandardOutPath` silently fails and logs are lost.

### bootstrap is idempotent in LaunchdService
`LaunchdService.bootstrap()` checks `queryStatus` first and boots out if already loaded,
preventing "Service already loaded" errors on app relaunch.

### ProcessStore is @MainActor, LaunchdService is actor
- All UI updates happen on `@MainActor` (ProcessStore)
- `LaunchdService` is a separate `actor` (background queue)
- Communication: `await launchd.bootstrap(...)` from ProcessStore — Swift concurrency handles the hop
- Never call `LaunchdService` methods from a non-async context

### App data location
| Data | Path |
|------|------|
| Process configs (JSON) | `~/Library/Application Support/com.guardian.app/processes.json` |
| LaunchAgent plists | `~/Library/LaunchAgents/com.guardian.<uuid>.plist` |
| Log files | `~/Library/Logs/Guardian/<label>.log` |

---

## Testing approach (manual — no unit tests yet)

**launchd integration test (verified 2026-02-23):**
```bash
# Bootstrap a test agent
cat > ~/Library/LaunchAgents/com.guardian.test.sleep.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict>
    <key>Label</key><string>com.guardian.test.sleep</string>
    <key>ProgramArguments</key><array><string>/bin/sleep</string><string>9999</string></array>
    <key>RunAtLoad</key><true/><key>KeepAlive</key><true/>
    <key>StandardOutPath</key><string>/tmp/guardian-test.log</string>
    <key>StandardErrorPath</key><string>/tmp/guardian-test.log</string>
</dict></plist>
EOF
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.guardian.test.sleep.plist
launchctl list com.guardian.test.sleep   # verify PID present

# Test KeepAlive (must use launchctl kill, not system kill)
launchctl kill SIGKILL gui/$(id -u)/com.guardian.test.sleep
sleep 15
launchctl list com.guardian.test.sleep   # new PID, LastExitStatus=9

# Cleanup
launchctl bootout gui/$(id -u)/com.guardian.test.sleep
rm ~/Library/LaunchAgents/com.guardian.test.sleep.plist
```

**App binary verification:**
```bash
# Check LSUIElement and min version
/usr/libexec/PlistBuddy -c "Print :LSUIElement" /Applications/Guardian.app/Contents/Info.plist
/usr/libexec/PlistBuddy -c "Print :LSMinimumSystemVersion" /Applications/Guardian.app/Contents/Info.plist

# Check architecture (should be universal)
file /Applications/Guardian.app/Contents/MacOS/Guardian

# Confirm not in Dock
osascript -e 'tell application "System Events"
    set dockProcs to name of every process whose background only is false
    return "Guardian" is in dockProcs
end tell'  # should return false

# Check lsappinfo (more reliable than System Events for LSUIElement apps)
/usr/bin/lsappinfo list | grep -A5 "Guardian"   # should show type="UIElement"
```

**Note:** `System Events` AppleEvent queries for LSUIElement apps will **always timeout** (-1712).
Use `lsappinfo` or direct binary inspection instead.

---

## GitHub repository

- **URL:** https://github.com/yzs981130/guardian
- **Releases:** https://github.com/yzs981130/guardian/releases
- **Latest release:** v0.1.1 (first stable, universal binary)
- **Protocol:** SSH (`git@github.com:yzs981130/guardian.git`)

---

## Future work / known gaps

- [ ] Unit tests for `LaunchdService` (mock `Process` execution)
- [ ] Log rotation support in `LogWatcher` (watch `.rename`/`.delete` events and reopen)
- [ ] Table-based environment variable editor (current is indexed tuple array)
- [ ] Table-based argument editor (current is space-separated string — breaks paths with spaces)
- [ ] Process groups / tagging
- [ ] Export/import process configs
- [ ] Crash notification via `UserNotifications`
- [ ] Optional code signing for cleaner Gatekeeper experience
